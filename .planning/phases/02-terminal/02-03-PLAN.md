---
phase: 02-terminal
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/components/Layout.tsx
  - src/components/Pane.tsx
  - src/components/Toolbar.tsx
  - src/stores/panes.ts
  - src/stores/sessions.ts
  - src/App.tsx
  - package.json
autonomous: true
---

<objective>
Build multi-pane layout manager with split, resize, focus, and close-with-undo.

Purpose: Users need to create, arrange, and manage multiple terminal panes in a spatial layout. This is the core UX that makes Kobo a "tmux for AI conversations."

Output: Multi-pane layout with horizontal/vertical splits, drag-to-resize, click-to-focus, active/inactive visual states, and close-with-undo.
</objective>

<tasks>

<task type="auto">
  <name>Task 1: Create Zustand stores for pane and session state</name>
  <files>package.json, src/stores/panes.ts, src/stores/sessions.ts</files>
  <action>
    Install zustand: npm install zustand

    Create src/stores/panes.ts:
    - Pane tree structure: each node is either a Leaf (terminal pane) or a Split (horizontal/vertical with two children + ratio).
    - PaneNode type: { type: 'leaf', id, sessionId } | { type: 'split', direction: 'horizontal'|'vertical', children: [PaneNode, PaneNode], ratio: number }
    - Store state: root PaneNode, activePaneId, closedPanes (for undo).
    - Actions: createPane, splitPane(direction), closePane(id) with undo buffer, focusPane(id), resizePane(id, ratio), undoClose.
    - When closing: move pane to closedPanes with 8-second timeout for undo.

    Create src/stores/sessions.ts:
    - Store sessions list synced from daemon.
    - Actions: fetchSessions, createSession, destroySession.
    - Bridge to daemon IPC calls.
  </action>
  <verify>npm run build</verify>
  <done>Zustand stores manage pane tree and session state with undo support</done>
</task>

<task type="auto">
  <name>Task 2: Create Layout component with split pane rendering</name>
  <files>src/components/Layout.tsx, src/components/Pane.tsx, src/components/Toolbar.tsx</files>
  <action>
    Create src/components/Pane.tsx:
    - Wraps Terminal component with pane chrome (border, header).
    - Shows active state (bright border) vs inactive (dim border).
    - Pane header: session name, close button.
    - Click handler to focus pane.
    - Shows [+N -M] placeholder for future change indicators.

    Create src/components/Layout.tsx:
    - Recursively renders pane tree from Zustand store.
    - For Split nodes: renders two children with a drag handle between them.
    - Drag handle: mousedown starts resize, mousemove updates ratio, mouseup finishes.
    - Uses CSS flexbox with flex-basis for split ratios.
    - Handles minimum pane sizes (don't let panes collapse below 100px).

    Create src/components/Toolbar.tsx:
    - Top toolbar with: "New Conversation" button, split horizontal button, split vertical button.
    - Undo close button (appears when closedPanes is non-empty).
    - Status indicator: daemon connected/disconnected dot.
    - Shows current active model and session count.
  </action>
  <verify>npm run build</verify>
  <done>Layout renders recursive pane tree with drag-to-resize and visual focus states</done>
</task>

<task type="auto">
  <name>Task 3: Wire everything together in App.tsx and add keyboard shortcuts</name>
  <files>src/App.tsx, src/hooks/useKeyboard.ts</files>
  <action>
    Create src/hooks/useKeyboard.ts:
    - Listen for keyboard events at document level.
    - Ctrl+B prefix key (like tmux): after pressing Ctrl+B, next key is a command:
      - " (shift+') -> split horizontal
      - % (shift+5) -> split vertical
      - Arrow keys -> navigate between panes
      - x -> close current pane
      - z -> undo close
      - c -> new conversation
    - Cmd+C / Cmd+V -> copy/paste (handled by xterm.js selection)

    Rewrite App.tsx:
    - On mount: connect to daemon, fetch sessions, restore layout or create default single pane.
    - Render: Toolbar at top, Layout filling remaining space.
    - Hook up keyboard shortcuts.
    - Handle daemon disconnect/reconnect gracefully.
  </action>
  <verify>npm run build</verify>
  <done>Full multi-pane UI with keyboard shortcuts, split, resize, focus, close+undo</done>
</task>

</tasks>
