---
phase: 03-claude-integration
plan: 01
type: execute
wave: 1
depends_on: ["02-03"]
files_modified:
  - crates/kobo-daemon/src/process.rs
  - crates/kobo-daemon/src/session.rs
  - crates/kobo-daemon/src/server.rs
  - crates/kobo-core/src/types.rs
  - src-tauri/src/commands.rs
  - src/lib/ipc.ts
  - src/stores/sessions.ts
  - src/components/Toolbar.tsx
autonomous: true
---

<objective>
Wire Claude CLI as the PTY process for sessions, with model selection and working directory configuration.

Purpose: When users create a new conversation, the daemon spawns `claude` CLI (the Anthropic CLI) as the shell process in the PTY instead of a bare shell. Users can pick between opus, sonnet, and haiku models. The daemon finds the `claude` binary on PATH or via common install locations.

Output: Sessions spawn Claude CLI with the selected model, and the model selection UI lets users choose before creating a conversation.
</objective>

<tasks>

<task type="auto">
  <name>Task 1: Update PTY process spawning to launch Claude CLI</name>
  <files>crates/kobo-daemon/src/process.rs, crates/kobo-core/src/types.rs</files>
  <action>
    Update ProcessManager::create() to:
    - Accept a `command` parameter (default: "claude") and `args` (e.g., ["--model", "sonnet"]).
    - Find the `claude` binary: check PATH, then ~/.claude/local/bin/claude, then /usr/local/bin/claude.
    - If claude not found, fall back to user's default shell ($SHELL or /bin/zsh) so sessions still work.
    - Set working directory for the PTY process (default to $HOME).
    - Pass through environment variables (TERM=xterm-256color, plus existing env).

    Update Session type in kobo-core/types.rs:
    - Add `command: Option<String>` field (what was spawned).
    - Add `shell_fallback: bool` field (whether claude was unavailable).

    Verify: cargo test --workspace
  </action>
  <verify>cargo test --workspace 2>&1 | tail -20</verify>
  <done>Sessions spawn claude CLI with model selection, falling back to shell if unavailable</done>
</task>

<task type="auto">
  <name>Task 2: Add model selection to session creation flow</name>
  <files>crates/kobo-daemon/src/server.rs, crates/kobo-daemon/src/session.rs, src-tauri/src/commands.rs, src/lib/ipc.ts</files>
  <action>
    Update session creation to pass model through the full stack:
    - CreateSessionBody already has model field
    - SessionManager::create_session should pass model to ProcessManager
    - ProcessManager constructs the claude command: `claude --model {model}`
    - Available models: opus, sonnet, haiku (validated on the daemon side)
    - Invalid model name -> return error before spawning

    Update Tauri commands to accept model parameter (already in place from Phase 2).
    Update ipc.ts createSession to pass model (already done).

    Add a `list_models` Tauri command that returns available models:
    - For v1, hardcode: [{id: "opus", name: "Claude Opus"}, {id: "sonnet", name: "Claude Sonnet"}, {id: "haiku", name: "Claude Haiku"}]
    - Later this will query the provider trait.

    Verify: cargo check -p kobo-tauri && npm run build
  </action>
  <verify>cargo check -p kobo-tauri && npm run build 2>&1 | tail -10</verify>
  <done>Model selection flows from UI through Tauri to daemon, validated before spawning</done>
</task>

<task type="auto">
  <name>Task 3: Add model picker UI and connection error display</name>
  <files>src/components/Toolbar.tsx, src/components/ModelPicker.tsx, src/stores/sessions.ts, src/App.tsx</files>
  <action>
    Create src/components/ModelPicker.tsx:
    - Dropdown or popup showing available models.
    - Currently selected model highlighted.
    - Clicking a model updates the session store's default model.
    - Small, unobtrusive design fitting the toolbar.

    Update Toolbar:
    - Add model picker before "New" button.
    - Show current default model.
    - When creating a new conversation, use the selected model.

    Update App.tsx:
    - Show a clear error banner when Claude CLI is not found (shell fallback mode).
    - Include a message: "Claude CLI not found. Install it at https://docs.anthropic.com/..."
    - Don't block the app -- sessions still work in shell mode.

    Update sessions store:
    - Add `defaultModel` state.
    - Use it when creating sessions.

    Verify: npm run build
  </action>
  <verify>npm run build 2>&1 | tail -10</verify>
  <done>Users can select model from toolbar, sessions launch with chosen model, errors shown clearly</done>
</task>

</tasks>
