---
phase: 03-claude-integration
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - crates/kobo-daemon/src/keystore.rs
  - crates/kobo-daemon/src/lib.rs
  - crates/kobo-daemon/Cargo.toml
  - src-tauri/src/commands.rs
  - src-tauri/src/lib.rs
  - src/lib/ipc.ts
  - src/components/ApiKeySetup.tsx
  - src/App.tsx
autonomous: true
---

<objective>
Add secure API key storage and connection error handling.

Purpose: Users need their Anthropic API key stored securely (macOS Keychain / Linux libsecret) and clear feedback when something goes wrong (key missing, CLI not installed, network errors).

Output: API key flows securely from Keychain to Claude CLI, and all error states have clear user-facing messages.
</objective>

<tasks>

<task type="auto">
  <name>Task 1: Add secure API key storage via macOS Keychain</name>
  <files>crates/kobo-daemon/src/keystore.rs, crates/kobo-daemon/src/lib.rs, crates/kobo-daemon/Cargo.toml</files>
  <action>
    Add keyring crate to kobo-daemon (cross-platform Keychain/libsecret wrapper):
    cargo add keyring --package kobo-daemon

    Create crates/kobo-daemon/src/keystore.rs:
    - KeyStore struct with get_api_key(), set_api_key(key), delete_api_key(), has_api_key() -> bool
    - Uses keyring crate with service="kobo" and username="anthropic-api-key"
    - Falls back to checking ANTHROPIC_API_KEY env var if keychain fails
    - KeyStoreError enum for clear error types

    Add module to lib.rs.

    Verify: cargo check -p kobo-daemon
  </action>
  <verify>cargo check -p kobo-daemon 2>&1 | tail -10</verify>
  <done>API keys stored in macOS Keychain / libsecret, with env var fallback</done>
</task>

<task type="auto">
  <name>Task 2: Pass API key to Claude CLI and add key management commands</name>
  <files>crates/kobo-daemon/src/process.rs, src-tauri/src/commands.rs, src-tauri/src/lib.rs, src/lib/ipc.ts</files>
  <action>
    Update ProcessManager::create():
    - Before spawning claude, check keystore for API key.
    - Set ANTHROPIC_API_KEY environment variable on the PTY process.
    - If no key available, return a clear error.

    Add Tauri commands:
    - has_api_key() -> bool
    - set_api_key(key: String) -> Result<(), String>
    - delete_api_key() -> Result<(), String>

    Add keystore to DaemonState or create a separate KeyStoreState.
    Register new commands in lib.rs.
    Add IPC wrappers in ipc.ts.

    Verify: cargo check -p kobo-tauri && npm run build
  </action>
  <verify>cargo check -p kobo-tauri && npm run build 2>&1 | tail -10</verify>
  <done>API key flows from keychain to Claude CLI process, key management commands available</done>
</task>

<task type="auto">
  <name>Task 3: Add API key setup UI and error handling</name>
  <files>src/components/ApiKeySetup.tsx, src/App.tsx, src/stores/sessions.ts</files>
  <action>
    Create src/components/ApiKeySetup.tsx:
    - Shown when no API key is configured.
    - Text input for API key (masked, paste-friendly).
    - "Save" button that calls set_api_key.
    - Link to Anthropic dashboard for getting a key.
    - "Skip" option (use shell mode without Claude).

    Update App.tsx:
    - On daemon connect, check has_api_key().
    - If no key: show ApiKeySetup before the main UI.
    - If key exists: proceed normally.
    - After key is set, restart into normal mode.

    Add error handling for common Claude CLI errors:
    - "Invalid API key" -> show re-entry dialog
    - "Rate limited" -> show backoff message
    - "Network error" -> show connection status
    - These appear as toast-like notifications overlaid on the terminal.

    Verify: npm run build
  </action>
  <verify>npm run build 2>&1 | tail -10</verify>
  <done>Users can set API key securely, errors shown clearly, skip option for shell-only mode</done>
</task>

</tasks>
