---
phase: 04-versioning
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src-tauri/src/commands.rs
  - src-tauri/src/lib.rs
  - src/lib/ipc.ts
  - src/components/Timeline.tsx
  - src/components/Pane.tsx
  - src/hooks/useVersioning.ts
  - src/stores/sessions.ts
autonomous: true
---

<objective>
Add timeline UI for milestones with save, view, diff, and restore.

Purpose: Users need a visual timeline of their saves with the ability to view diffs and restore to any point.

Output: Pane save button, timeline panel, diff view, and restore action.
</objective>

<tasks>

<task type="auto">
  <name>Task 1: Add Tauri commands and IPC wrappers for versioning</name>
  <files>src-tauri/src/commands.rs, src-tauri/src/lib.rs, src/lib/ipc.ts</files>
  <action>
    Add Tauri commands:
    - save_milestone(session_id, message) -> Milestone
    - list_milestones(session_id, limit) -> Vec<Milestone>
    - diff_milestones(session_id, from_oid, to_oid) -> DiffSummary
    - restore_milestone(session_id, oid) -> ()

    Register commands in lib.rs.
    Add typed IPC wrappers in ipc.ts.

    Verify: cargo check -p kobo-tauri && npm run build
  </action>
  <verify>cargo check -p kobo-tauri && npm run build 2>&1 | tail -10</verify>
  <done>Versioning commands available from frontend</done>
</task>

<task type="auto">
  <name>Task 2: Create Timeline component and save action in Pane</name>
  <files>src/components/Timeline.tsx, src/components/Pane.tsx, src/hooks/useVersioning.ts, src/stores/sessions.ts</files>
  <action>
    Create src/hooks/useVersioning.ts:
    - useVersioning(sessionId) -> { milestones, save, diff, restore, isLoading }
    - Fetches milestones on mount and after save.
    - save(message) calls save_milestone.
    - diff(from, to) calls diff_milestones.
    - restore(oid) calls restore_milestone with confirmation.

    Create src/components/Timeline.tsx:
    - Slide-out panel (right side) showing milestone history.
    - Each milestone: time, message, files changed count.
    - Click milestone to select, show diff against current.
    - Restore button with confirmation.
    - Compact, non-intrusive design.

    Update Pane.tsx:
    - Add save button (disk icon) in pane header.
    - Clicking save prompts for milestone message (inline input).
    - Add timeline toggle button (clock icon).

    Verify: npm run build
  </action>
  <verify>npm run build 2>&1 | tail -10</verify>
  <done>Users can save milestones, view timeline, diff and restore from UI</done>
</task>

</tasks>
