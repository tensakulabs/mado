---
phase: 04-versioning
plan: 01
type: execute
wave: 1
depends_on: ["03-02"]
files_modified:
  - crates/kobo-daemon/src/git_ops.rs
  - crates/kobo-daemon/src/lib.rs
  - crates/kobo-daemon/src/server.rs
  - crates/kobo-daemon/src/session.rs
  - crates/kobo-daemon/Cargo.toml
  - crates/kobo-core/src/types.rs
  - crates/kobo-core/src/protocol.rs
  - crates/kobo-core/src/client.rs
autonomous: true
---

<objective>
Add local git repo per session for versioning. Each session's working directory gets a git repo. Users can save milestones (commits) and list them.

Purpose: Track changes in conversation workspaces so users can save, view history, and restore.

Output: Daemon creates git repos per session, commits on save, lists milestones via API.
</objective>

<tasks>

<task type="auto">
  <name>Task 1: Create git_ops module for git operations</name>
  <files>crates/kobo-daemon/src/git_ops.rs, crates/kobo-daemon/src/lib.rs, crates/kobo-daemon/Cargo.toml</files>
  <action>
    Add git2 crate: cargo add git2 --package kobo-daemon

    Create crates/kobo-daemon/src/git_ops.rs:
    - init_repo(path) -> Result: Init a new git repo at path if not already a repo.
    - save_milestone(path, message) -> Result<Milestone>: Stage all changes, commit with message, return milestone info.
    - list_milestones(path, limit) -> Result<Vec<Milestone>>: Walk commit history, return recent milestones.
    - diff_milestone(path, from_oid, to_oid) -> Result<DiffSummary>: Get diff stats between two commits.
    - restore_milestone(path, oid) -> Result<()>: Hard reset to a commit.
    - Milestone type: { oid: String, message: String, timestamp: DateTime, files_changed: usize, insertions: usize, deletions: usize }
    - DiffSummary type: { files: Vec<FileDiff> } where FileDiff = { path, insertions, deletions, status }

    Add to lib.rs module list.

    Verify: cargo check -p kobo-daemon
  </action>
  <verify>cargo check -p kobo-daemon 2>&1 | tail -10</verify>
  <done>Git operations module handles init, save, list, diff, restore</done>
</task>

<task type="auto">
  <name>Task 2: Add versioning endpoints and wire through full stack</name>
  <files>crates/kobo-daemon/src/server.rs, crates/kobo-core/src/types.rs, crates/kobo-core/src/protocol.rs, crates/kobo-core/src/client.rs, crates/kobo-daemon/src/session.rs</files>
  <action>
    Add types to kobo-core/types.rs:
    - Milestone struct (matching git_ops)
    - DiffSummary and FileDiff structs

    Add protocol variants:
    - DaemonResponse::Milestones { milestones }
    - DaemonResponse::MilestoneSaved { milestone }
    - DaemonResponse::DiffResult { diff }

    Add daemon API endpoints:
    - POST /sessions/{id}/save { message } -> save milestone
    - GET /sessions/{id}/milestones?limit=20 -> list milestones
    - GET /sessions/{id}/diff?from={oid}&to={oid} -> diff
    - POST /sessions/{id}/restore { oid } -> restore

    Add DaemonClient methods for each endpoint.

    Update SessionManager to delegate to git_ops.

    Verify: cargo test --workspace
  </action>
  <verify>cargo test --workspace 2>&1 | tail -20</verify>
  <done>Full versioning API from daemon endpoints through client library</done>
</task>

</tasks>
